---
title: "Amazon RDS を停止させたままにしたい場合の解決法"
slug: "solution-if-you-want-to-keep-amazon-rds-stopped"
tags: [ "AWS", "Amazon-RDS" ]
thumbnail: "images/logo/aws_logo.svg"
description: "Amazon RDS を停止させたままにしたい場合の解決法を備忘録として残しておく"
mathjax: false
mermaid: false
iframe: false
date: 2024-10-29T13:00:00+09:00
draft: false
type: "post"
---

Amazon RDS は一時停止した場合、[最大7日間までしか停止できない](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_StopInstance.html)  
しかし停止させたままにしたい状況が発生したため調査を行なった  
その際のまとめを備忘録として残しておく

## 解決案

1つ目の方法が推奨だが今回は諸事情により 2つ目を採用

* [Lambda 関数を使用する](https://repost.aws/ja/knowledge-center/rds-stop-seven-days)
* [EventBridgeを使用する](https://dev.classmethod.jp/articles/rds-stop-with-amazon-eventbridge-scheduler-and-cloudformation/)

### 実際の手順

1. 以下の CloudFormation テンプレートを使用して stack を作成

```.yml
---
AWSTemplateFormatVersion: '2010-09-09'
Description:  EventBridge Scheduler to stop RDS instance

Parameters:
  InstanceId:
    Type: String
  ScheduleStopTime:
    Type: String
    Default: "cron(0 20 * * ? *)"
  ScheduleTimezone:
    Type: String
    Default: Japan

Resources:
  # EventBridgeScheduler???
  ScheduleRDSStop:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub 'RDS-Stop-${InstanceId}'
      Description: Stop RDS Instance
      ScheduleExpression: !Ref ScheduleStopTime 
      ScheduleExpressionTimezone: !Ref ScheduleTimezone
      FlexibleTimeWindow:
        Mode: "OFF"
      State: ENABLED
      Target:
        Arn: arn:aws:scheduler:::aws-sdk:rds:stopDBInstance
        Input: !Sub |-
          {
            "DbInstanceIdentifier": "${InstanceId}"
          }
        RoleArn:
          Fn::GetAtt:
          - SchedulerRDSStopRole
          - Arn
  # EventBridgeScheduler?????IAM??????     
  SchedulerRDSStopRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - scheduler.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      Policies:
        - PolicyName: rdsstop
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - rds:StopDBInstance
                Resource:
                  - "*"
```

2. 以下のパラメータを指定

* 対象のインスタンス(DB 識別子)
  * 例. sample-db
* 停止のスケジュール(cron 式)
  * 例. cron(0 20 * * ? *)
* タイムゾーン
  * 例. japan

3. 作成されたリソースを確認

  3-1. Amazon EventBridge > スケジュール > <<対象のスケジュール>>

### 注意点

上記のスケジューラ起動時に DB が起動の途中だったりすると失敗するため注意が必要  
※停止時間を調整する
