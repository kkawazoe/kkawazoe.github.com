---
title: "Rails 8.1 リリースノートまとめ"
slug: "rails-8-1-release-notes-summary"
tags: [ "Ruby On Rails" ]
thumbnail: "images/logo/rails_logo.svg"
description: "Rails 8.1 リリースノートについてまとめたものを備忘録として残しておく"
mathjax: false
mermaid: false
iframe: false
date: 2025-09-09T9:00:00+09:00
draft: false
type: "post"
---

Rails 8.1 リリースノートについてまとめたものを備忘録として残しておく

* [Rails 7 リリースノートまとめ]({{< ref "20250318_01.md" >}})
* [Rails 7.1 リリースノートまとめ]({{< ref "20250318_02.md" >}})
* [Rails 7.2 リリースノートまとめ]({{< ref "20250319_01.md" >}})
* [Rails 8 リリースノートまとめ]({{< ref "20250319_02.md" >}})

Rails 8.1 のリリースノートは以下の通り

## Rails 8.1 系での新機能および変更点

### Railties

* `rails credentials:fetch PATH` コマンドが追加された
* フィクスチャで動的 ERB 式の代わりに静的 BCrypt パスワードダイジェストが生成されるようになった
* `.gitignore`エントリが拡張され、すべてのキーファイルが無視されるようになった
* `bin/setup`に`--reset` オプションが追加された
* `GitHub Actions`ワークフローテンプレートの`RuboCop`ジョブに`RuboCop`キャッシュ復元が追加された
* `ActionMailer`を使用しないアプリケーションで認証ジェネレータがメーラー関連ファイルの生成をスキップするようになった
* `bin/ci`が導入され、テスト、スタイルチェック、セキュリティ監査をローカルまたはクラウドで実行できるようになった
* 認証ジェネレータ実行時にセッションコントローラテストが生成されるようになった
* `bin/bundler-audit`と`config/bundler-audit.yml`が追加され、アプリケーションgemの既知のセキュリティ問題を発見・管理できるようになった
* `bin/bundlebinstub`の生成が停止された
* `SessionTestHelper`モジュールが追加され、`sign_in_as(user)`と`sign_out`テストヘルパーが提供されるようになった
* 認証ジェネレータでパスワードリセットのレート制限が追加された
* `rails new --minimal`オプションが更新され、最近追加された機能が除外されるようになった
* アプリケーションレイアウトに`application-name`メタデータが追加された
* ローカルで`ENV`または`credentials`から`secret_key_base`が使用されるようになった
* 生成された`ci.yml`ファイルに`RAILS_MASTER_KEY`プレースホルダーが導入された
* 非標準環境でも Rails コンソールプロンプトがカラー化されるようになった
* 開発環境とテスト環境で YJIT が有効化されなくなった
* ポリシーが設定されている場合のみ`PermissionsPolicy::Middleware`が含まれるようになった

### Action Cable

* ActionCable::Channel#stream_for に複合チャネルを渡せるようになった
  * 例: `stream_for [ group, group.owner ]`
* Redis のサブスクリプション接続識別子に nil を設定できるようになった

### Action Pack

* `action_controller.logger`を nil または false に設定することで無効化できるようになった
* `.md/.markdown`が Markdown 拡張として追加され、デフォルトの`markdown:レンダラー`が追加された
* エンジンルート検査コマンドにヘッダーが追加された
* エラーページに「Copy as text」ボタンが追加された
* `rate_limit`メソッドに`scope:オプション`が追加された
* `ActionDispatch::Executor`で`rack.response_finished`コールバックのサポートが追加された
* `rescue_from`が呼び出されたときにログが生成されるようになった
* Rails 設定の hosts からのホストリダイレクトが許可されるようになった
* `rate_limit.action_controller`通知に追加のペイロードが含まれるようになった
* 組み込みヘルスコントローラーに JSON サポートが追加された
* ブラウザからクラッシュでソースファイルを開けるようになった
* クエリ文字列キーが値と同様に有効なエンコーディングかチェックされるようになった
* `PublicExceptions`と`DebugExceptions`で HEAD リクエストの空のボディが常に返されるようになった
* `RFC 9111`に従った HTTP Cache-Control リクエストディレクティブの包括的なサポートが追加された
* `assert_in_body/assert_not_in_body`がレスポンスボディ内のテキストをチェックする最も簡単な方法として追加された
* クッキー名が最大許可サイズの計算に含まれるようになった
* `RFC 9111`に従った`must-understand`ディレクティブが実装された
* JSON レンダラーが HTML エンティティや Unicode 行区切り文字をエスケープしなくなった
* テストルートを挿入する前に遅延ルートセットが読み込まれるようになった
* レンダリング後に head が呼び出された場合に`AbstractController::DoubleRenderError`が発生するようになった
* `Cookie Serializer`がメッセージパックを使用する際に`Active Support SafeBuffer`をシリアライズできるようになった
* `Rails.application.reload_routes!`がほぼすべてのルートをクリアする問題が修正された
* #resource または#resources に無効な :only または :except オプションが与えられた場合のArgumentErrorにリソース名が追加された
* 存在しないコントローラーを指すルートが 404 ではなく 500 を返すようになった
* `ActionDispatch::Session::CacheStore`に`check_collisions`オプションが追加された
* `ExceptionWrapper`でビルトインテンプレートとのバックトレース行のマッチングが改善された
* Mimeタイプ のシンボルでコンテンツタイプを設定できるようになった

### Action View

* `preload_link_tag`で生成される HTML と一致するように Link ヘッダーに fetchpriority が追加された
* `preload_link_tag`で生成される Link ヘッダーに CSP nonce が追加された
* `current_page?`が`method:`オプションで特定の HTTP メソッドとマッチできるようになった
* `form_tag`,`token_tag`,`method_tag`で生成される隠し入力から autocomplete="off" が削除された
* `button_to`,`check_box`,`select（multiple付き）`,`file_field`フォームに含まれる隠しパラメータフィールドから autocomplete="off" が削除された
* `Action View`テンプレート間の依存関係を追跡する戦略の設定が有効になった
* `relative_time_in_words`ヘルパーが導入された
* `nonce: false`が javascript_tag, javascript_include_tag, stylesheet_link_tag から nonce 属性を削除するようになった
* 無制限の数のオブジェクトから dom_id のような文字列を作成する dom_target ヘルパーが追加された
* `collection_checkboxes`が隠し`<input>`を生成する際に`html_options[:form]`が尊重されるようになった
* レイアウトが render に渡されるローカル変数にアクセスできるようになった
* テンプレートの strict locals に関連する引数エラーが`ActionView::StrictLocalsError`を発生させるようになった
* ERB テンプレートまたは do-end ブロック内でエラーが発生した場合のマルチライン メソッドのエラーハイライトが改善された
* コンパイルされたテンプレートでソーステンプレートの終端を超えた行でエラーが発生した場合の ERB テンプレートエラーハイライトのクラッシュが修正された
* ERB テンプレートエラーハイライトの信頼性が向上し、ハイライトでの無限ループとクラッシュが修正され、代替 ERB ハンドラーの許容性が改善された
* `hidden_field`と`hidden_field_tag`がカスタム autocomplete 値を受け入れるようになった
* `content_security_policy_nonce_directives`設定オプションで指定されたディレクティブの影響を受けるタグに nonce を自動的に追加する新しい設定`content_security_policy_nonce_auto`が追加された

### Action Mailer

* deliver_all_laterが追加され、複数のメールを一度にエンキューできるようになった

### Active Record

* `libpq >= 18`と`pg < 1.6.0`の互換性問題により、`cancel_any_running_query`で`PG::Connection#cancel`の呼び出しがスキップされるようになった
* 新しいデータベース設定オプション`keepalive`,`max_age、min_connections`が導入され、 pool が max_connections にリネームされた
* LIMIT 検証がクエリ生成時から limit() が呼び出された時に移動された
* `ActiveRecord::CheckViolation`エラークラスがチェック制約違反用に追加された
* `ActiveRecord::ExclusionViolation`エラークラスが排他制約違反用に追加された
* `filter_attributes`でフィルタされた属性が`filter_parameters`でもフィルタされるようになった
* `connection.current_transaction.isolationAPI`が現在のトランザクションの分離レベルをチェックできるようになった
* `#merge`と`#or`または`#and`と属性と SQL 文字列の混合で不正なクエリが生成される問題が修正された
* スキーマダンパーが :ruby 形式でダンプする際に`ActiveRecord.dump_schemas`を考慮するようになった
* `update_column/update_columns`メソッドに :touch オプションが追加された
* Active Record バッチングが範囲を使用する際にさらに最適化された
* インデックスとテーブル名の長さ検証のエラーメッセージに現在の文字長が含まれるようになった
* PostgreSQL 用の rename_schema メソッドが追加された
* アソシエーションの非推奨化サポートが実装された
* PostgreSQL アダプタの create DB が locale_provider と locale をサポートするようになった
* PostgreSQL で ntuples を使用して row_count を populateするようになった
* 永続化されていないレコードが厳密に読み込まれた has_and_belongs_to_many アソシエーションに include? されるかどうかのチェックが修正された
* ブロック内のすべてのプールのトランザクション分離を変更する機能が追加された
* 順序に依存するファインダーメソッド（#first、#last）が順序値なしで呼び出された場合に`ActiveRecord::MissingRequiredOrderError`が発生するようになった
* 多態性 belongs_to アソシエーションで :class_name が無効になった
* db:migrate:reset が複数データベースをサポートするようになった
* `ActiveRecord::Result`に affected_rows が追加された
* 再試行可能な SqlLiterals を #where に渡すことができるようになった
* `insert_all/upsert_all`で主キーのデフォルトが設定されるようになった
* `ActiveRecord::DatabaseConfigurations`用のロードフック`active_record_database_configurations`が追加された
* SQLite クエリで boolean カラムに TRUE と FALSE が使用されるようになった
* サポートされる SQLite の最小バージョンが 3.23.0 に引き上げられた
* 割り当てられた Active Record がアソシエーションをルックアップできるようになった
* 暗号化が属性ごとに`support_unencrypted_data: true`を設定することをサポートするようになった
* モデルジェネレータがデータベース接続なしでカラムタイプを検証できるようになった
* 署名付き ID 検証器が`Rails.application.message_verifiers`で設定可能になった
* `PostgreSQL`の`structure_load`で`extra_flags`が前置されるようになった
* `implicit_order_column`で主キー/制約の追加をバイパスできるようになった
* データベース設定で`schema_format`を設定できるようになった
* MySQL v8.0.0+ と MariaDB v10.6.0+でインデックスの無効化がサポートされた
* `ActiveRecord::Relation#reverse_order`で`implicit_order_column`が尊重されるようになった
* SQLite3 用の`ActiveRecord::Result`にカラムタイプが追加された
* 読み取り専用ロールで悲観的ロックを使用した場合に`ActiveRecord::ReadOnlyError`が発生するようになった
* Rails アプリケーション外で SQLite3Adapter の dbconsole メソッドを使用する問題が修正された
* `ActiveRecord::PendingMigration`アクションで複数データベースのマイグレーションが修正された
* 接続エラーで冪等なアソシエーションクエリの自動再試行が有効になった
* sql.active_record 計装に allow_retry が追加された
* PostgreSQL と SQLite3 で JOIN を使用した UPDATE のサポートが改善された
* `ActiveSupport::Testing::Parallelization`に before-fork フックが導入され、既存の接続がクリアされるようになった
* PoolConfig が接続クラスへの参照を保持しなくなった
* 非同期クエリを使用する際に SQL 通知が送信されない場合がある問題が修正された
* PostgreSQL でダンプされたスキーマキャッシュの読み込みクエリが排除された
* `ActiveRecord::Coder::JSON`がインスタンス化できるようになった
* アソシエーション内の永続化されていないレコードで`insert_all/upsert_all`を使用することが非推奨になった
* `index_exists?`でカラム名がオプションになった
* `sql.active_record`通知のペイロード名が`eager loading`で「SQL」から「`#{model.name} Eager Load`」に変更された
* 接続エラーで冪等な`#exists?`クエリの自動再試行が有効になった
* `update_all`とサポートされていないメソッドの併用が非推奨になった
* `schema.rb`内のテーブルカラムがアルファベット順にソートされるようになった
* スキーマダンパー用のバージョンフォーマッターが導入された
* シリアライズされた属性が比較可能としてマークできるようになった
* `MySQL`のデフォルト関数がカラムの`nullability`を変更する際に削除される問題が修正された
* `SQLite`拡張が`config/database.yml`で設定できるようになった
* `ActiveRecord::Middleware::ShardSelector`が細かいデータベース接続切り替えをサポートするようになった
* `insert_all/upsert_all`後にリレーションがリセットされるようになった
* 並列テストデータベースのサフィックスに_Nが使用されるようになった
* データベース接続が最近検証されたことを記憶するようになった
* 複数のレコードのキャッシュカウンターをリセットできるようになった
* `sql.active_record`通知に`affected_rows`が追加された
* グループ化された計算でsumが修正された
* データベースごとにトランザクションテストの有効/無効がサポートされるようになった
* URL 設定を使用する際に query_cache 値がキャストされるようになった
* `NULLS NOT DISTINCT`が`UNIQUE CONSTRAINT`と`UNIQUE INDEX`の両方で動作するようになった
* `PG::UnableToSend: no connection to the server`が接続関連の例外として再試行可能になった

### Active Storage

* GCP メタデータサーバーへの不要な呼び出しが削除された
* ダイレクトアップロードの進行状況がサーバー処理時間を考慮するようになった
* `ActiveStorage::Filename#to_str`が`#to_s`に委譲されるようになった
* `config.active_storage.checksum_implementation`を通じて代替MD5実装のサポートが追加された
* Blob が関連する Attachment を自動保存しなくなった

### Active Model

* バリデーションコールバックに except_on: オプションが追加された
* `ActiveRecord::Normalization`が`ActiveModel::Attributes::Normalization`にバックポートされた

### Active Support

* `ActiveSupport::Cache::Store#namespace=`と`#namespace`が追加された
* 並列テスト実行用の`parallel_worker_id`ヘルパーが作成された
* `ActiveSupport::Cache::Strategy::LocalCache::Middleware`のキャッシュが更新可能になった
* `ActiveSupport::EventReporter`用のassert_events_reportedテストヘルパーが追加された
* `ActiveSupport::TimeZone#standard_name`メソッドが追加された
* `Rails.event`でアクセス可能なStructured Event Reporterが追加された
* `ActiveSupport::Logger`が#freezeフレンドリーになった
* `ActiveSupport::Gzip.compress`が入力に基づいて決定論的になった
* `ActiveSupport::BacktraceCleaner#clean_locations`メソッドが追加された
* `CurrentAttributesとExecutionContext`の状態管理がテストケースで改善された
* `ActiveSupport::BacktraceCleaner#first_clean_location`メソッドが追加された
* `FileUpdateChecker`と`EventedFileUpdateChecker`が Gem.path の変更を無視するようになった
* `ActiveSupport::BacktraceCleaner#first_clean_frame`メソッドが追加された
* `CurrentAttributes`インスタンスが常にクリアされるようになった
* 並列テストで`before_fork_hook`のパブリック API が追加された
* 並列テストデータベースの作成をスキップする機能が実装された
* 最大キャッシュキーサイズの設定が可能になった
* `ActiveSupport::Cache::RedisCacheStore`で非ブロッキング削除にUNLINKコマンドが使用されるようになった
* `Cache#read_counter`と`Cache#write_counter`が追加された
* `ActiveSupport::Testing::ErrorReporterAssertions#capture_error_reports`が導入された
* `ActiveSupport::ErrorReporter#add_middleware`が導入された
* 実行ラッピングがすべての例外（Exceptionを含む）を報告するように変更された
* `ActiveSupport::Testing::Parallelization.before_fork_hook`でテストワーカーフォーク直前に呼び出されるコールバックの宣言が可能になった
* `#freeze_time`テストヘルパーが日付または時間引数を受け入れるようになった
* `ActiveSupport::JSON`がオプションを受け入れるようになった
* `ActiveSupport::Testing::NotificationAssertionsのassert_notification`がデフォルトでペイロードサブセットとマッチするようになった
* `nil.to_query("key")`がkeyを返すようになった
* `ActiveSupport::Cache::RedisCacheStore`で :redis オプションが既に ConnectionPool の場合に Redis を ConnectionPool でラップしないようになった
* `ERB::Util.tokenize`が ERB タグを含まない文字列で完全な入力文字列と :PLAIN トークンを返すように変更された
* `ERB::Util.tokenize`でマルチバイト文字の前に ERB タグがある場合の不正なトークン化バグが修正された
* `ActiveSupport::Testing::NotificationAssertions`モジュールが`ActiveSupport::Notifications`のテストを支援するために追加された
* `ActiveSupport::CurrentAttributes#attributes`が各呼び出しで新しいハッシュオブジェクトを返すようになった
* `ActiveSupport::JSON.encode`が`CIDR`記法をサポートするようになった
* `ActiveSupport::FileUpdateChecker`が多くのファイル拡張子をチェックする際に高速化された

### Active Job

* `ActiveJob::Serializers::ObjectSerializers#klass`メソッドがパブリックになった
* `ActiveJob::Continuablez` を使用してジョブを中断・再開できるようになった
* `enqueue_after_transaction_commit`が有効な場合の ActiveJob エンキューコールバックの呼び出しがコミット後に延期されるようになった
* ActiveJob::Base#retry_onと#discard_onにreport:オプションが追加された
* ActiveJob::ConfiguredJob#perform_laterがブロックを受け入れるようになった
* デシリアライゼーション時に以前にシリアライズされたジョブクラスが不明な場合により具体的なエラーが発生するようになった

### Action Text

* `fill_in_rich_text_area`オプションが Capybara に転送されるようになった
* アタッチメントアップロードの進行状況がサーバー処理時間を考慮するようになった
* Trix 依存関係がベンダーファイルではなく action_text-trixgem で満たされるようになった
* `ActionText::RichText#embeds`の割り当てが before_save から before_validation に変更された

### Action Mailbox

* Mail::Message に reply_to_address 拡張メソッドが追加された

## 非推奨および削除された機能

### Action Pack

* 以下が削除された
  * パラメータ名の先頭の角括弧([])をスキップする機能
  * クエリ文字列のセミコロン(;)区切りのサポート
  * 複数のパスに対するルート設定のサポート
* `Rails.application.config.action_dispatch.ignore_leading_brackets` が非推奨になった

### Active Record

* 以下が削除された
  * SQLite3 アダプターの `:retries` オプション
  * MySQL の以下のカラムメソッド
    * `:unsigned_float`
    * `:unsigned_decimal`

### Active Storage

* `azure` ストレージサービスが削除された

### Active Job

* 以下が削除された
  * `ActiveJob::Base.enqueue_after_transaction_commit` を `:never`, `:always`, `:default` に設定するサポート
  * `Rails.application.config.active_job.enqueue_after_transaction_commit`
  * 内部の `SuckerPunch` アダプタ
